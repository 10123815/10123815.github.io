---
layout:     post
title:      "TCP协议通信流程"
date:       2016-06-17
author:     "ysd"
header-img: "img/post-bg-2015.jpg"
tags:      
        - tcp
---

![](/img/in-post/2016-06-17-tcp.jpg)

+ listen()调用后，对于给定的监听套接口，内核要维护两个队列：
    1. 已由客户发出SYN并到达服务器，服务器正在等待完成相应的TCP三次握手过程，若三路握手完成，该项就移至已完成连接队列
    2. 已完成连接的队列
+ accept()从已完成连接队列返回第一个连接，如果已完成连接队列为空，则阻塞
+ connect()发出SYN_SENT，并阻塞程序，等待应答；收到ACK后返回
    1. 若客户端没收到SYN分节的响应，则返回ETIMEOUT错误;
    2. 若对客户的响应是RST(表示复位)，表明服务器上指定端口没有进程与之连接，客户收到RST返回ECONNREFUSED错误
+ 由于TCP连接是全双工的，接收到FIN时意味将没有数据再发来，但是还是可以继续发送数据。
因此每个方向都必须单独进行关闭。
这个原则是当一方完成它的数据发送任务后就能发送一个FIN来终止这个方向的连接。
收到一个 FIN只意味着这一方向上没有数据流动，一个TCP连接在收到一个FIN后仍能发送数据。

![](/img/in-post/2016-07-29-tcp.jpg)
